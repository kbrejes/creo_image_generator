# Ad Creative Agent - Dify Workflow (Final)
# Fully automated: Input → Image → Text Overlay → Done

name: "Meme Ad Generator"
description: "Generate meme-style ads with AI images and copy"
mode: "chatflow"

# ===================
# WORKFLOW DIAGRAM
# ===================
#
#  [Start]
#     │
#     ▼
#  [LLM: Analyze Input] ──────────────────┐
#     │                                    │
#     ▼                                    ▼
#  [LLM: Generate Copy]            [LLM: Image Prompt]
#     │                                    │
#     │                                    ▼
#     │                         [HTTP: Generate Image]
#     │                                    │
#     └──────────────┬─────────────────────┘
#                    ▼
#            [HTTP: Compose Ad]
#                    │
#                    ▼
#            [LLM: Format Response]
#                    │
#                    ▼
#                 [End]

# ===================
# NODE 1: START
# ===================
# Dify creates this automatically
# Input variable: {{#sys.query#}}

# ===================
# NODE 2: ANALYZE INPUT (LLM)
# ===================
node_analyze:
  type: llm
  title: "Analyze Input"
  model: "claude-3-5-sonnet"  # Or any model you have

  system_prompt: |
    You analyze user requests for ad creation. Extract key info and respond with JSON only.

  user_prompt: |
    Analyze this ad request:

    {{#sys.query#}}

    Return JSON:
    {
      "product_name": "name of product/service/channel",
      "description": "what it is/does",
      "target_audience": "who it's for",
      "pain_points": ["problem 1", "problem 2"],
      "tone": "casual/professional/funny",
      "platform": "instagram/telegram/twitter"
    }

  output_variable: "product_info"

# ===================
# NODE 3: GENERATE COPY (LLM)
# ===================
node_copy:
  type: llm
  title: "Generate Meme Copy"
  model: "claude-3-5-sonnet"

  system_prompt: |
    You write meme-style ad copy. Short, punchy, internet humor.
    Rules:
    - Hook text goes at TOP of meme (attention-grabbing)
    - Body text goes at BOTTOM (optional punchline)
    - CTA is the call to action
    - Use ALL CAPS for hook
    - Keep it casual and relatable
    Respond with JSON only.

  user_prompt: |
    Create meme ad copy for:
    {{#node_analyze.product_info#}}

    Return JSON:
    {
      "hook": "TOP TEXT IN CAPS",
      "body": "bottom text (or empty string)",
      "cta": "call to action"
    }

  output_variable: "copy"

# ===================
# NODE 4: BUILD IMAGE PROMPT (LLM)
# ===================
node_image_prompt:
  type: llm
  title: "Build Image Prompt"
  model: "claude-3-5-sonnet"

  system_prompt: |
    You create prompts for AI image generation.
    CRITICAL: Never include text/words/letters in the prompt.
    Focus on reactions, expressions, relatable situations.
    End every prompt with: NO TEXT NO WORDS NO LETTERS

  user_prompt: |
    Create a meme-style image prompt for:
    {{#node_analyze.product_info#}}

    The image should show a funny/relatable reaction that matches the pain points.
    Return ONLY the prompt text, nothing else.

  output_variable: "image_prompt"

# ===================
# NODE 5: GENERATE IMAGE (HTTP)
# ===================
node_generate_image:
  type: http_request
  title: "Generate Image"

  method: POST
  url: "https://creo.yourads.io/tools/generate-image"
  headers:
    Content-Type: "application/json"

  body: |
    {
      "prompt": "{{#node_image_prompt.text#}}",
      "backend": "flux",
      "size": "1024x1024",
      "negative_prompt": "text, words, letters, writing, watermark"
    }

  output_variable: "generated_image"

# ===================
# NODE 6: COMPOSE AD (HTTP)
# ===================
node_compose:
  type: http_request
  title: "Compose Final Ad"

  method: POST
  url: "https://creo.yourads.io/pipeline/compose"

  # URL params (use Dify's param builder)
  params:
    image_url: "{{#node_generate_image.body.images[0].url#}}"
    hook_text: "{{#node_copy.hook#}}"
    body_text: "{{#node_copy.body#}}"
    cta_text: "{{#node_copy.cta#}}"
    output_size: "instagram_square"

  output_variable: "final_ad"

# ===================
# NODE 7: FORMAT RESPONSE (LLM)
# ===================
node_response:
  type: llm
  title: "Format Response"
  model: "claude-3-5-sonnet"

  user_prompt: |
    Format this for the user:

    Final Ad: {{#node_compose.body.url#}}

    Copy used:
    - Hook: {{#node_copy.hook#}}
    - Body: {{#node_copy.body#}}
    - CTA: {{#node_copy.cta#}}

    Create a friendly response with:
    1. The image URL (clickable)
    2. The copy that was used
    3. Ask if they want variations or different style

  output_variable: "response"

# ===================
# NODE 8: END
# ===================
# Output: {{#node_response.text#}}
