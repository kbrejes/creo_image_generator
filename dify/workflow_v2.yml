# Ad Creative Agent - Dify Workflow v2
# Refactored architecture: Dify handles LLM, FastAPI handles images + Figma

workflow:
  name: "Ad Creative Agent v2"
  description: "Create meme-style ads with separate image and text pipelines"
  version: "2.0.0"

# ===================
# Architecture
# ===================
#
# ┌─────────────────────────────────────────────────────────────────┐
# │                         DIFY WORKFLOW                           │
# │                                                                 │
# │  [User Input] ──→ [LLM: Extract Content] ──→ [LLM: Gen Copy]   │
# │                            │                        │           │
# │                            ▼                        ▼           │
# │                   [LLM: Image Prompt] ──→ [HTTP: Generate]     │
# │                                                   │             │
# │                                                   ▼             │
# │                          [LLM: Compose Figma Instructions]     │
# │                                                   │             │
# │                                                   ▼             │
# │                              [Return to User]                   │
# └─────────────────────────────────────────────────────────────────┘
#                                    │
#                           HTTP Calls to:
#                                    │
# ┌──────────────────────────────────▼──────────────────────────────┐
# │                    FastAPI Backend (localhost:8000)             │
# │                                                                 │
# │  POST /tools/generate-image  ──→  Returns image URL            │
# │  GET  /files/{filename}      ──→  Serves generated images      │
# └─────────────────────────────────────────────────────────────────┘

# ===================
# Node Configurations
# ===================

nodes:

  # ─────────────────────────────────────
  # NODE 1: Start
  # ─────────────────────────────────────
  - id: start
    type: start
    outputs:
      - name: user_message
        description: "Raw user input (URL, text, or description of what they want)"

  # ─────────────────────────────────────
  # NODE 2: Content Extraction (LLM)
  # ─────────────────────────────────────
  - id: extract_content
    type: llm
    description: "Extract product info from user input"
    config:
      model: "claude-3-5-sonnet"  # Or any model in your Dify
      system_prompt: |
        You extract structured marketing information from content. Always respond with valid JSON only.
      user_prompt: |
        Analyze this content and extract key information for creating ad creatives.

        USER INPUT:
        {{user_message}}

        Return a JSON object with:
        {
            "product_name": "Name of the product/service/brand",
            "description": "Clear, concise description (2-3 sentences)",
            "key_benefits": ["benefit 1", "benefit 2", "benefit 3"],
            "target_audience": "Who this is for",
            "pain_points_solved": ["pain point 1", "pain point 2"],
            "tone": "Brand tone",
            "industry": "Industry category"
        }
      response_format: json
    outputs:
      - name: product_info
        description: "Extracted product information as JSON"

  # ─────────────────────────────────────
  # NODE 3: Generate Copy (LLM)
  # ─────────────────────────────────────
  - id: generate_copy
    type: llm
    description: "Generate meme-style ad copy variations"
    config:
      model: "claude-3-5-sonnet"
      system_prompt: |
        You write meme-style ad copy that's informal, relatable, and slightly unpolished.

        Rules:
        - Use internet slang appropriately (but don't overdo it)
        - Self-aware humor works well
        - Short, punchy phrases
        - Feels like a friend recommending something
        - Emojis OK but use sparingly
        - ALL CAPS for emphasis occasionally

        Respond with valid JSON only.
      user_prompt: |
        Create 3 variations of meme-style ad copy for:

        {{product_info}}

        Each variation needs:
        - hook: Top text for meme (attention-grabbing)
        - body: Bottom text (1-2 sentences, optional)
        - cta: Call to action

        JSON format:
        {
            "variations": [
                {"hook": "...", "body": "...", "cta": "..."}
            ]
        }
      response_format: json
    outputs:
      - name: copy_variations
        description: "Generated copy variations"

  # ─────────────────────────────────────
  # NODE 4: Build Image Prompt (LLM)
  # ─────────────────────────────────────
  - id: build_image_prompt
    type: llm
    description: "Create image generation prompt (NO TEXT)"
    config:
      model: "claude-3-5-sonnet"
      system_prompt: |
        You create prompts for AI image generation. NEVER include text/words/letters in the prompt.
        Always end with "NO TEXT NO WORDS NO LETTERS"
      user_prompt: |
        Create a meme-style image prompt for:
        {{product_info}}

        Focus on: Funny reaction, relatable situation, meme aesthetic
        Return ONLY the prompt, ending with "NO TEXT NO WORDS NO LETTERS"
    outputs:
      - name: image_prompt
        description: "Image generation prompt"

  # ─────────────────────────────────────
  # NODE 5: Generate Image (HTTP)
  # ─────────────────────────────────────
  - id: generate_image
    type: http_request
    description: "Call FastAPI to generate image"
    config:
      method: POST
      url: "https://creo.yourads.io/tools/generate-image"
      headers:
        Content-Type: "application/json"
      body:
        prompt: "{{image_prompt}}"
        backend: "flux"
        size: "1024x1024"
        negative_prompt: "text, words, letters, writing, watermark"
    outputs:
      - name: generated_image
        description: "Generated image response with URL"

  # ─────────────────────────────────────
  # NODE 6: Format Response (LLM)
  # ─────────────────────────────────────
  - id: format_response
    type: llm
    description: "Create final response for user"
    config:
      model: "claude-3-5-sonnet"
      user_prompt: |
        Format this ad creative for the user:

        IMAGE: {{generated_image.images[0].url}}

        COPY OPTIONS:
        {{copy_variations}}

        Create a friendly response showing:
        1. The generated image
        2. The copy variations (formatted nicely)
        3. Instructions for composing in Figma:
           - Open Figma
           - Create frame (1080x1080 for Instagram)
           - Place the image
           - Add text using Impact font for meme style
           - Hook text at top, body at bottom
        4. Offer to generate more variations
    outputs:
      - name: final_response

  # ─────────────────────────────────────
  # NODE 7: End
  # ─────────────────────────────────────
  - id: end
    type: end
    input: "{{final_response}}"

# ===================
# Setup Instructions
# ===================

setup:
  steps:
    - title: "1. Start FastAPI Backend"
      command: |
        cd creo_image_generator
        python main.py
      note: "Server runs at https://creo.yourads.io"

    - title: "2. Create Dify Workflow"
      steps:
        - "Create new Chatflow in Dify"
        - "Add LLM nodes with prompts above"
        - "Add HTTP Request node for image generation"
        - "Connect nodes in sequence"

    - title: "3. Configure HTTP Node"
      config:
        url: "https://creo.yourads.io/tools/generate-image"
        method: "POST"
        body_type: "json"

    - title: "4. Test"
      example: "Create a meme ad for my Telegram channel about B2B lead generation and cold outreach tips"

# ===================
# API Endpoints
# ===================

api_reference:
  base_url: "https://creo.yourads.io"
  endpoints:
    - path: "/tools/generate-image"
      method: POST
      description: "Generate image without text"
      body:
        prompt: "string - The image prompt"
        backend: "string - 'flux' or 'dalle3'"
        size: "string - '1024x1024'"
        negative_prompt: "string - What to avoid"

    - path: "/health"
      method: GET
      description: "Check available backends"

    - path: "/files/{filename}"
      method: GET
      description: "Serve generated images"
